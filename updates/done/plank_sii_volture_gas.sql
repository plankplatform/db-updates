CREATE ALGORITHM=UNDEFINED DEFINER=`plank`@`%` SQL SECURITY DEFINER VIEW `plank_sii_volture_gas` AS with `autoletture` as (select `plank_gas_letture`.`particellaazienda` AS `particellaazienda`,`plank_gas_letture`.`pdr` AS `pdr`,`plank_gas_letture`.`datalettura` AS `datalettura`,round(ifnull(`plank_gas_letture`.`lettura`,`plank_gas_letture`.`lettura_conv`),0) AS `lettura`,row_number() OVER (PARTITION BY `plank_gas_letture`.`particellaazienda`,`plank_gas_letture`.`pdr` ORDER BY `plank_gas_letture`.`datalettura` desc )  AS `rn` from `plank_gas_letture` where ((`plank_gas_letture`.`tipolettura` = 'AUTOLETTURA') and (ifnull(`plank_gas_letture`.`lettura`,`plank_gas_letture`.`lettura_conv`) is not null))) select `CN`.`idcontratto` AS `id`,'VTG1' AS `COD_SERVIZIO`,'0050' AS `COD_FLUSSO`,`AZ`.`piva` AS `PIVA_UTENTE`,'05877611003' AS `PIVA_GESTORE`,left(concat(`CN`.`idcontratto`,'_',convert(uuid() using utf8mb4)),15) AS `CP_UTENTE`,`CN`.`pdr` AS `COD_PDR`,`CN`.`gas_remi` AS `COD_REMI`,(case `CN`.`tipologiacliente` when 'CONDOMINIO' then '1' when 'DOMESTICO' then '0' when 'AZIENDA' then '2' when 'AZIENDA SENZA PIVA' then '2' when 'ENTE' then '2' else '' end) AS `TIPO_PDR`,`L`.`codiceofferta_sii` AS `CODICE_CONTRATTO`,(case `CN`.`tipovoltura` when 'VOLTURA ORDINARIA' then '01' when 'VOLTURA MORTIS CAUSA' then '02' when 'INCORPORAZIONE SOCIETARIA' then '03' else '01' end) AS `TIPOLOGIA_VOLTURA`,date_format(curdate(),'%d/%m/%Y') AS `DATA_RICHIESTA`,date_format(`CN`.`decorrenza`,'%d/%m/%Y') AS `DATA_DECORRENZA`,'' AS `DATA_DECORRENZA_RET`,`AZ`.`piva` AS `PIVA_CONTROPARTE_COMMERCIALE`,'' AS `PIVA_UDB`,`CN`.`codfiscale` AS `CF`,`CN`.`piva` AS `PIVA`,coalesce(`CN`.`cf_straniero`,'0') AS `CF_STRANIERO`,trim(coalesce(upper(`CN`.`nome`),'')) AS `NOME`,trim(coalesce(upper(`CN`.`cognome`),'')) AS `COGNOME`,trim((case when ((trim(coalesce(upper(`CN`.`nome`),'')) <> '') and (trim(coalesce(upper(`CN`.`cognome`),'')) <> '')) then '' else upper(`CN`.`densociale`) end)) AS `RAGIONE_SOCIALE_DENOMINAZIONE`,coalesce(`CN`.`referenteamm_cell`,`CN`.`referenteamm_tel`,'') AS `TELEFONO`,`CN`.`referenteamm_email` AS `EMAIL`,'NO' AS `REFERENTE`,'' AS `REF_NOME`,'' AS `REF_COGNOME`,'' AS `REF_EMAIL`,'' AS `REF_TELEFONO`,coalesce(`CN`.`fornitura_toponimo`,'') AS `FOR_TOPONIMO`,coalesce(`CN`.`fornitura_via`,'') AS `FOR_VIA`,coalesce(`CN`.`fornitura_civico`,'') AS `FOR_CIV`,coalesce(`CN`.`fornitura_cap`,'') AS `FOR_CAP`,right(concat('000000',coalesce(`CN`.`fornitura_localita_id`,'')),6) AS `FOR_ISTAT`,coalesce(`CN`.`fornitura_localita`,'') AS `FOR_LOCALITA`,coalesce(`CN`.`fornitura_prov`,'') AS `FOR_PROV`,'ITALIA' AS `FOR_NAZIONE`,'' AS `FOR_ALTRO`,if((`CN`.`gas_residente` = 1),'SI','NO') AS `RESIDENZA`,if((`CN`.`tipologiacliente` = 'DOMESTICO'),convert(date_format(`CN`.`decorrenza`,'%d/%m/%Y') using utf8mb4),'') AS `DATA_VAL_RES`,'' AS `ES_TOPONIMO`,'' AS `ES_VIA`,'' AS `ES_CIV`,'' AS `ES_CAP`,'' AS `ES_ISTAT`,'' AS `ES_LOCALITA`,'' AS `ES_PROV`,'' AS `ES_NAZIONE`,'' AS `ES_ALTRO`,'' AS `AF_CF`,'' AS `AF_PIVA`,'' AS `AF_CF_STRANIERO`,'' AS `AF_NOME`,'' AS `AF_COGNOME`,'' AS `AF_RAGIONE_SOCIALE_DENOMINAZIONE`,ifnull(`CN`.`aliva`,'') AS `ALIQUOTA_IVA`,'' AS `ALIQUOTA_ACCISE`,'' AS `ADDIZ_REGIONALE`,'' AS `ALTRE_INFORMAZIONI`,'M1' AS `TIPO_FORNITURA`,concat(coalesce(`CN`.`codiceateco`,''),convert(if(((coalesce(`CN`.`codiceateco`,'') <> '') and (length(`CN`.`codiceateco`) > 1)),concat(substr('00.00.00',(length(`CN`.`codiceateco`) + 1))),'') using utf8mb3)) AS `SETT_MERCEOLOGICO`,'' AS `CODICE_UFFICIO`,'' AS `PAGAMENTO_IVA`,coalesce(left(`CN`.`gas_destinazioneuso_classe`,2),'') AS `CAT_USO`,coalesce(right(`CN`.`gas_destinazioneuso_classe`,1),'') AS `CLASSE_PRELIEVO`,coalesce(`CN`.`gas_consumoprevisto`,'') AS `PREL_ANNUO_PREV`,'SI' AS `PRESENZA_DS`,'NO' AS `EROG_SERVIZIO_ENERG`,'' AS `SE_PIVA`,'' AS `SE_CF`,'' AS `SE_RAGIONE_SOCIALE_DENOMINAZIONE`,'' AS `SE_TELEFONO`,'' AS `SE_EMAIL`,'' AS `SE_TOPONIMO`,'' AS `SE_VIA`,'' AS `SE_CIV`,'' AS `SE_CAP`,'' AS `SE_ISTAT`,'' AS `SE_LOCALITA`,'' AS `SE_PROV`,'' AS `SE_NAZIONE`,'' AS `SE_ALTRO`,if((`AL`.`pdr` is not null),convert(date_format(`AL`.`datalettura`,'%d/%m/%Y') using utf8mb4),'') AS `DATA_ACQUISIZIONE`,if((`AL`.`pdr` is not null),`AL`.`lettura`,'') AS `DATO_AUTOLETTURA`,'NO' AS `ACCESSO_FUI`,`CN`.`statolavorazione` AS `statolavorazione`,`AG`.`densociale` AS `grossista`,`CN`.`particellaazienda` AS `particellaazienda` from ((((((`plank_contratti_forniture_gas` `CN` join `plank_volture` `V` on((`CN`.`idcontratto` = `V`.`idcontratto_new`))) left join `plank_assegnazionefornitori_gas` `AF` on(((`AF`.`idcontratto` = `CN`.`idcontratto`) and (`AF`.`decorrenza` <= `CN`.`decorrenza`) and (`AF`.`scadenza` > `CN`.`decorrenza`)))) left join `plank_anagraficagrossisti` `AG` on(((`CN`.`particellaazienda` = `AG`.`particellaazienda`) and (`AG`.`codicegrossista` = `AF`.`codicegrossista`)))) left join `plank_aziende` `AZ` on((`AZ`.`particellaazienda` = `CN`.`particellaazienda`))) left join `plank_listini_gas` `L` on(((`L`.`particellaazienda` = `CN`.`particellaazienda`) and (`L`.`codiceofferta` = `CN`.`gas_codiceofferta`)))) left join `autoletture` `AL` on(((`AL`.`particellaazienda` = `CN`.`particellaazienda`) and (`AL`.`pdr` = `CN`.`pdr`) and (`AL`.`rn` = 1)))) where (`CN`.`statolavorazione` = 'ATTESA VOLTURA')