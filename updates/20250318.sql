UPDATE `comm`.`plank_pianirientro_template` SET `structure` = '{\n    \"logo\": false,\n    \"email\": {\n        \"body\": \"<p class=\\\"corpo\\\">Prot. n. [[protocollo]]</p><p class=\\\"corpo\\\">[[sedeoperativa_localita]], [[oggi]]</p><p class=\\\"corpo\\\">Oggetto: Atto di riconoscimento del debito e piano di rientro  [[densociale]] [[codcliente]]</p><p>&nbsp;</p><p class=\\\"corpo\\\">Gentile Cliente,</p><p class=\\\"corpo\\\">in allegato inviamo il Piano di rientro concordato.</p><p class=\\\"corpo\\\">Per qualsiasi domanda o chiarimento, il nostro Servizio Clienti è a tua disposizione ai seguenti orari e contatti:</p><p class=\\\"corpo\\\">Orari: Lunedì-Venerdì 9.30-12.30 / 14.00-16.00</p><p class=\\\"corpo\\\">Tel. [[servizioclienti_tel]]</p><p class=\\\"corpo\\\">Mail: [[servizioclienti_email]]</p><p>&nbsp;</p><p class=\\\"corpo\\\">Cordiali saluti</p><p class=\\\"corpo\\\">[[sedeoperativa_localita]], lì [[oggi]]</p>\",\n        \"subject\": \"Atto di riconoscimento del debito e piano di rientro  [[densociale]] [[codcliente]]\"\n    },\n    \"firma\": true,\n    \"testi\": [\n        \"Si impegna a corrispondere tramite bonifico bancario tale somma secondo le seguenti scadenze:\",\n        \"Il pagamento delle rate, il cui singolo importo sarà imputato ai sensi degli artt. 1193 e 1194 c.c., e in specie a saldo, via via, delle fatture insolute, da quella di più antica emissione alla più recente, dovrà avvenire mediante \",\n        \"<p class=\\\"page-break\\\"></p>\",\n        \"<br><br><br>Ti preghiamo di inviare il presente piano sottoscritto per accettazione rispondendo a questa E-mail entro 2 giorni dalla data di ricevimento, con l’avviso che, in difetto, il presente piano di rientro sarà privo di efficacia e i versamenti eventualmente effettuati saranno come sopra imputati in acconto di quanto complessivamente dovuto.\",\n        \"Precisiamo, inoltre, che, al mancato pagamento anche di una sola delle sopra elencate rate alle scadenze indicate, il presente accordo decadrà dal beneficio del termine, conseguendone che la Società [[nomeazienda]] sarà libera di agire per ogni e qualsiasi importo di propria spettanza e si vedrà costretta ad inoltrare richiesta di disalimentazione della rete elettrica/gas di tuo riferimento.\",\n        \"&nbsp;\",\n        \"<b>In fede,<br><br>[[densociale]]</b>\",\n        \"<br><br>[[line]]<br><br>\",\n        \"Per qualsiasi domanda o chiarimento, il nostro Servizio Clienti è a tua disposizione ai seguenti orari e contatti:<br>Orari: Lunedì-Venerdì 9.30-12.30 / 14.00-16.00<br>Tel. [[servizioclienti_tel]]<br>E-mail: [[servizioclienti_email]]<br>\"\n    ],\n    \"saluti\": \"<p>Distinti Saluti.<br><br>[[sedeoperativa_localita]], lì [[oggi]]</p>\",\n    \"causale\": \"<b>Causale: [[codcliente]] N° piano di rientro [[protocollo]] e N° rata</b>\",\n    \"oggetto\": \"Atto di riconoscimento del debito e piano di rientro [[densociale]] [[codcliente]]<br><br><br><br>Piano di rientro n. [[protocollo]]/[[annocomunicazione]] del [[data]] per debito di € [[debito]]<br><br>\",\n    \"BONIFICO\": \"bonifico bancario utilizzando le seguenti coordinate:\",\n    \"path_footer\": \"footer_powerit.php\",\n    \"path_header\": \"header_powerit.html\",\n    \"testo_firma\": \"\",\n    \"intestazione\": \"Premesso che [[densociale]] si dichiara debitore nei confronti di [[nomeazienda]] per la somma di € [[debito]] per quanto concerne le seguenti fatture:\",\n    \"new_line_before_saluti\": false\n}' WHERE (`id` = '5');
UPDATE `comm`.`plank_pianirientro_template` SET `structure` = '{\n    \"logo\": false,\n    \"email\": {\n        \"body\": \"<p class=\\\"corpo\\\">Prot. n. [[protocollo]]</p><p class=\\\"corpo\\\">[[sedeoperativa_localita]], [[oggi]]</p><p class=\\\"corpo\\\">Oggetto: Atto di riconoscimento del debito e piano di rientro  [[densociale]] [[codcliente]]</p><p>&nbsp;</p><p class=\\\"corpo\\\">Gentile Cliente,</p><p class=\\\"corpo\\\">in allegato inviamo il Piano di rientro concordato.</p><p class=\\\"corpo\\\">Per qualsiasi domanda o chiarimento, il nostro Servizio Clienti è a tua disposizione ai seguenti orari e contatti:</p><p class=\\\"corpo\\\">Orari: Lunedì-Venerdì 9.30-12.30 / 14.00-16.00</p><p class=\\\"corpo\\\">Tel. [[servizioclienti_tel]]</p><p class=\\\"corpo\\\">Mail: [[servizioclienti_email]]</p><p>&nbsp;</p><p class=\\\"corpo\\\">Cordiali saluti</p><p class=\\\"corpo\\\">[[sedeoperativa_localita]], lì [[oggi]]</p>\",\n        \"subject\": \"Atto di riconoscimento del debito e piano di rientro  [[densociale]] [[codcliente]]\"\n    },\n    \"firma\": true,\n    \"testi\": [\n        \"Si impegna a corrispondere tramite bonifico bancario tale somma secondo le seguenti scadenze:\",\n        \"Il pagamento delle rate, il cui singolo importo sarà imputato ai sensi degli artt. 1193 e 1194 c.c., e in specie a saldo, via via, delle fatture insolute, da quella di più antica emissione alla più recente, dovrà avvenire mediante \",\n        \"<p class=\\\"page-break\\\"></p>\",\n        \"<br><br><br>Ti preghiamo di inviare il presente piano sottoscritto per accettazione rispondendo a questa E-mail entro 2 giorni dalla data di ricevimento, con l’avviso che, in difetto, il presente piano di rientro sarà privo di efficacia e i versamenti eventualmente effettuati saranno come sopra imputati in acconto di quanto complessivamente dovuto.\",\n        \"Precisiamo, inoltre, che, al mancato pagamento anche di una sola delle sopra elencate rate alle scadenze indicate, il presente accordo decadrà dal beneficio del termine, conseguendone che la Società [[nomeazienda]] sarà libera di agire per ogni e qualsiasi importo di propria spettanza e si vedrà costretta ad inoltrare richiesta di disalimentazione della rete elettrica/gas di tuo riferimento.\",\n        \"&nbsp;\",\n        \"<b>In fede,<br><br>[[densociale]]</b>\",\n        \"<br><br>[[line]]<br><br>\",\n        \"Per qualsiasi domanda o chiarimento, il nostro Servizio Clienti è a tua disposizione ai seguenti orari e contatti:<br>Orari: Lunedì-Venerdì 9.30-12.30 / 14.00-16.00<br>Tel. [[servizioclienti_tel]]<br>E-mail: [[servizioclienti_email]]<br>\"\n    ],\n    \"saluti\": \"<p>Distinti Saluti.<br><br>[[sedeoperativa_localita]], lì [[oggi]]</p>\",\n    \"causale\": \"<b>Causale: [[codcliente]] N° piano di rientro [[protocollo]] e N° rata</b>\",\n    \"oggetto\": \"Atto di riconoscimento del debito e piano di rientro [[densociale]] [[codcliente]]<br><br><br><br>Piano di rientro n. [[protocollo]]/[[annocomunicazione]] del [[data]] per debito di € [[debito]]<br><br>\",\n    \"BONIFICO\": \"bonifico bancario utilizzando le seguenti coordinate:\",\n    \"path_footer\": \"footer_powerit.php\",\n    \"path_header\": \"header_powerit.html\",\n    \"testo_firma\": \"\",\n    \"intestazione\": \"Premesso che [[densociale]] si dichiara debitore nei confronti di [[nomeazienda]] per la somma di € [[debito]] per quanto concerne le seguenti fatture:\",\n    \"new_line_before_saluti\": false\n}' WHERE (`id` = '6');
UPDATE `comm`.`plank_contrattidigitali_allegati_template` SET `posnum_firme` = '3,45,59;' WHERE (`id` = '62');

CREATE DEFINER=`plank`@`%` PROCEDURE `plank_dogane_reportannuale_dettaglio_ee`(IN var_azienda varchar(45), IN var_anno INT, var_token varchar(45))
BEGIN
    
DROP TEMPORARY TABLE IF EXISTS tmp_dettagli;
CREATE TEMPORARY TABLE tmp_dettagli
SELECT F.tipologiacliente, D.*
FROM comm.plank_fatture_dettaglio D
INNER JOIN comm.plank_fatture F on D.particellaazienda = D.particellaazienda and D.codicefattura = F.codicefattura
WHERE D.particellaazienda=var_azienda AND D.utility="EE" AND year(D.dataemissione)=var_anno 
	AND (D.cod like "erariale\_%" or (D.cod like "energia%" AND D.voce not like 'Perdite%')) 
	AND D.importo <> 0;

   
DROP TEMPORARY TABLE IF EXISTS tmp_primafattura;
CREATE TEMPORARY TABLE tmp_primafattura
SELECT idcontratto, periodoriferimento, CONCAT(particellaazienda,"_",minfattura,"_",annoemissione,"_",seriale) AS codicefattura
FROM
(
SELECT D.idcontratto, D.periodoriferimento, D.particellaazienda, D.minfattura, annoemissione, seriale, row_number() OVER (partition by  D.idcontratto, D.periodoriferimento order by annoemissione) rn
FROM
(
	SELECT D.idcontratto, D.periodoriferimento,D.particellaazienda, MIN(D.numerofattura) as minfattura,  YEAR(dataemissione) as annoemissione, D.seriale
	from comm.plank_fatture_dettaglio D 
	where D.particellaazienda = var_azienda 
	AND (D.cod like "erariale\_%" or (D.cod like "energia%" AND D.voce not like 'Perdite%'))
    AND YEAR(dataemissione) <= var_anno
	GROUP BY D.idcontratto, D.periodoriferimento,  YEAR(dataemissione), D.seriale
	) D
) A WHERE rn = 1; 

DROP TEMPORARY TABLE IF EXISTS tmp_storico_fornitura;
CREATE TEMPORARY TABLE tmp_storico_fornitura
SELECT *
FROM
(
	SELECT f.codicefattura, f.dataemissione, f.idcontratto, e.destinazioneuso_accise, e.potenzaimpegnata, IF(e.residente<>"1", 0, 1) AS residente, e.codicetensione, e.percesclusioneaccise,
    e.coddogane, e.impiantofotovoltaicopresente, e.zonaipex, NULLIF(e.distributore, "") as distributore, row_number() over (partition by f.codicefattura, f.dataemissione, f.idcontratto order by e.datastoricizzazione desc) as rn
	
    from 
	(
		SELECT codicefattura, dataemissione, idcontratto 
		FROM tmp_dettagli D
		group by codicefattura, dataemissione, idcontratto 
	) f
	left join  plank_forniture_ee_storico e on f.idcontratto = e.idcontratto and e.datastoricizzazione >= f.dataemissione
) e where rn = 1;



DROP TEMPORARY TABLE IF EXISTS tmp_storico_contratto;
CREATE TEMPORARY TABLE tmp_storico_contratto
SELECT *
FROM
(
	SELECT f.codicefattura, f.dataemissione, f.idcontratto,  
    NULLIF(e.codfiscale, "") AS codfiscale, NULLIF(e.piva, "") as piva,
    Coalesce(NULLIF(e.fornitura_codfiscale, ""), NULLIF(e.codfiscale, "")) AS fornitura_codfiscale, 
    Coalesce(NULLIF(e.fornitura_piva, ""), NULLIF(e.piva, ""))  AS fornitura_piva, 
    e.densociale, e.tipologiacliente, e.fornitura_indirizzo, e.fornitura_localita_id, e.fornitura_prov, e.fornitura_paese, e.decorrenza, e.scadenza, e.datadistipula,
    row_number() over (partition by f.codicefattura, f.dataemissione, f.idcontratto order by e.datastoricizzazione desc) as rn
	from 
	(
		SELECT codicefattura, dataemissione, idcontratto 
		FROM tmp_dettagli D
		group by codicefattura, dataemissione, idcontratto 
	) f
	left join  plank_contratti_storico e on f.idcontratto = e.idcontratto and e.datastoricizzazione >= f.dataemissione
) e where rn = 1;


DROP TEMPORARY TABLE IF EXISTS tmp_storico_campi;
CREATE TEMPORARY TABLE tmp_storico_campi
SELECT *
FROM
(
	SELECT D.idcontratto, D.periodoriferimento,  D.codicefattura, SUM(CASE WHEN S.nomecampo = 'potenzaimpegnata' THEN S.valoredouble ELSE NULL END) AS potenzaimpegnata, 
	SUM(CASE WHEN S.nomecampo = 'residente' THEN S.valoredouble ELSE NULL END) as residente, GROUP_CONCAT(CASE WHEN S.nomecampo = 'codicetensione' THEN S.valoretesto ELSE NULL END SEPARATOR ',') AS codicetensione
	FROM
	(
		SELECT distinct D.idcontratto, D.codicefattura, D.periodoriferimento, coalesce(SC.decorrenza, C.decorrenza) as decorrenza,
        coalesce(SC.scadenza, C.scadenza) as scadenza
		FROM tmp_dettagli D
        LEFT JOIN tmp_storico_contratto SC ON D.idcontratto = SC.idcontratto and SC.codicefattura = D.codicefattura
        LEFT JOIN plank_contratti C on D.idcontratto = C.idcontratto
	) D
	INNER JOIN plank_forniture_ee E on D.idcontratto = E.idcontratto
	INNER JOIN plank_storicocampi S on E.id = S.pkriga and LEAST(D.decorrenza, CONCAT(D.periodoriferimento,'01')) between S.da and S.a
	GROUP BY D.idcontratto, D.periodoriferimento
) s
where potenzaimpegnata IS NOT NULL and residente IS NOT NULL and codicetensione IS NOT NULL;
 
DROP TEMPORARY TABLE IF EXISTS tmp_fatturato;
CREATE TEMPORARY TABLE tmp_fatturato
SELECT D.codicefattura, D.dataemissione, D.idcontratto, D.periodoriferimento, D.pdp, sum(quantita) AS consumo
FROM tmp_dettagli D
WHERE D.cod like "energia%" AND D.voce not like 'Perdite%'
GROUP BY D.codicefattura, D.dataemissione, D.idcontratto, D.periodoriferimento;

 DROP TEMPORARY TABLE IF EXISTS tmp_erariale;
CREATE TEMPORARY TABLE tmp_erariale
SELECT D.codicefattura, D.dataemissione, D.idcontratto, D.periodoriferimento, D.pdp, 
sum(quantita) as consumoaccise, corrispettivounitario as corrispettivoaccisa
FROM tmp_dettagli D
WHERE D.cod like "erariale%"
GROUP BY D.codicefattura, D.dataemissione, D.idcontratto, D.periodoriferimento, corrispettivounitario;

DROP TEMPORARY TABLE IF EXISTS tmp_gc;
CREATE TEMPORARY TABLE tmp_gc
SELECT *
FROM
(
select provincia, id_citta, cod_fisco, country_code, ambitogas, zonaclimaticagas,macrozonagas, zonaipex,
row_number() over(partition by id_citta order by inactive) rn
    from comm.plank_geo_cities 
    where country = 'Italy'
) gc 
WHERE rn = 1;

DROP TEMPORARY TABLE IF EXISTS tmp_consumi;
CREATE TEMPORARY TABLE tmp_consumi
SELECT D.codicefattura, D.dataemissione, D.idcontratto, D.periodoriferimento, D.pdp, D.consumo, D.consumoaccise,
D.consumo - (D.esenti + IF((D.periodoriferimento < '202301' OR (Coalesce(sc.codicetensione, s.codicetensione, E.codicetensione) like 'TD%' 
	AND Coalesce(sc.residente, s.residente, E.residente, 0) =1 AND D.periodoriferimento >= '202301')) AND Coalesce(sc.potenzaimpegnata, s.potenzaimpegnata, E.potenzaimpegnata) > 1.5 AND 
	Coalesce(sc.potenzaimpegnata, s.potenzaimpegnata, E.potenzaimpegnata)<=3  AND D.esenti < 150 and D.consumo >220 , LEAST(150, D.consumo-220),0 )) AS consumotassato, 
D.esenti, Coalesce(D.rettifica, 0) as rettifica,
IF((D.periodoriferimento < '202301' OR (Coalesce(sc.codicetensione, s.codicetensione, E.codicetensione) like 'TD%' 
	AND Coalesce(sc.residente, s.residente, E.residente, 0) =1 AND D.periodoriferimento >= '202301')) AND Coalesce(sc.potenzaimpegnata, s.potenzaimpegnata, E.potenzaimpegnata)>1.5 AND Coalesce(sc.potenzaimpegnata, s.potenzaimpegnata, E.potenzaimpegnata)<=3 AND D.esenti < 150 and D.consumo >220, LEAST(150, D.consumo-220),0 ) as recuperataResidente,
Coalesce(c.tipologiacliente, E.tipologiacliente) as tipologiacliente, coalesce(s.destinazioneuso_accise, E.destinazioneuso_accise) as destinazioneuso_accise, Coalesce(sc.residente, s.residente, E.residente, 0) AS residente,
coalesce(s.percesclusioneaccise, E.percesclusioneaccise) as percesclusioneaccise,
coalesce(sc.potenzaimpegnata, s.potenzaimpegnata, E.potenzaimpegnata) as potenzaimpegnata, Coalesce(sc.codicetensione, s.codicetensione, E.codicetensione) as codicetensione,
Coalesce(NULLIF(Coalesce(c.codfiscale, NULLIF(E.codfiscale, "")), ""), Coalesce(c.piva, NULLIF(E.piva,""))) as fattura_codfiscale, 
Coalesce(NULLIF(Coalesce(c.fornitura_codfiscale, NULLIF(E.fornitura_codfiscale, ""), NULLIF(E.codfiscale,"")), ""), Coalesce(c.fornitura_piva, NULLIF(E.fornitura_piva,""), NULLIF(E.piva,""))) as fornitura_codfiscale, 
Coalesce(gc.cod_fisco, "") as codcat, REPLACE(Coalesce(c.fornitura_indirizzo, E.fornitura_indirizzo), TRIM(REGEXP_REPLACE(Coalesce(c.fornitura_indirizzo, E.fornitura_indirizzo), "[A-Za-z0-9àèéìòù .,\\-()'\/]{1,50}",""))," ") as fornitura_indirizzo,
Coalesce(c.fornitura_localita_id, E.fornitura_localita_id) as fornitura_localita_id, Coalesce(gc.provincia, c.fornitura_prov, E.fornitura_prov) as fornitura_prov, 
Coalesce(gc.country_code, c.fornitura_paese, E.fornitura_paese) as fornitura_paese, Coalesce(c.decorrenza, E.decorrenza) as decorrenza, Coalesce(c.scadenza, E.scadenza) as scadenza,
Coalesce(c.datadistipula, E.datadistipula) as datadistipula,
Coalesce(s.coddogane,E.coddogane) as coddogane, Coalesce(s.impiantofotovoltaicopresente,E.impiantofotovoltaicopresente, 0) as impiantofotovoltaicopresente, 
Coalesce(gc.zonaipex, s.zonaipex, E.zonaipex) as zonaipex, corrispettivoaccisa, D.scaglione,
-- Ambito: identificato dalle seguenti sigle province: Sigla Provincia della sede della Ditta, IT, AO, BZ, TN, TS, PA, CA escludendo il capoluogo dell’ambito dove ha sede la ditta, 
-- considerando la provincia fittizia IT il capoluogo di provincia dell'ambito ORDINARIO
CASE WHEN D.sedelegale_prov = Coalesce(gc.provincia, c.fornitura_prov, E.fornitura_prov) OR ambitoditta = 
	CASE WHEN Coalesce(gc.provincia, c.fornitura_prov, E.fornitura_prov) IN ("BZ", "TN") THEN Coalesce(gc.provincia, c.fornitura_prov, E.fornitura_prov)
	WHEN pr.id_regione = 19 THEN "AO" 
    WHEN pr.id_regione = 14 THEN "CA"
	WHEN pr.id_regione = 15 THEN "PA"
    WHEN pr.id_regione = 6 THEN "TS"
    ELSE "IT" END THEN ambitoditta ELSE
    CASE WHEN Coalesce(gc.provincia, c.fornitura_prov, E.fornitura_prov) IN ("BZ", "TN") THEN Coalesce(gc.provincia, c.fornitura_prov, E.fornitura_prov)
	WHEN pr.id_regione = 19 THEN "AO" 
    WHEN pr.id_regione = 14 THEN "CA"
	WHEN pr.id_regione = 15 THEN "PA"
    WHEN pr.id_regione = 6 THEN "TS"
    ELSE "IT" END END AS ambito, 
	coalesce(ad.pivadistr, ad1.pivadistr) as pivadistr
FROM
(
	select D.*, Coalesce(F.consumo, 0) as consumo, Coalesce(E.consumoaccise, 0) as consumoaccise,
	Coalesce(F.consumo, 0) - Coalesce(E.consumoaccise, 0) as esenti, Coalesce(E.corrispettivoaccisa, 0) as corrispettivoaccisa,
    IF (Coalesce(E.consumoaccise, 0)<200000, 1, 2) AS scaglione
	from (
		SELECT  DISTINCT D.codicefattura, D.idcontratto, D.periodoriferimento, D.dataemissione, D.pdp,
        IF(D.codicefattura <> PF.codicefattura, 1, 0) AS rettifica, A.sedelegale_prov, pr.capoluogo,
        CASE WHEN pr.capoluogo = 1 THEN 
			CASE WHEN A.sedelegale_prov IN ("BZ", "TN") THEN A.sedelegale_prov
			WHEN pr.id_regione = 19 THEN "AO" 
			WHEN pr.id_regione = 14 THEN "CA"
			WHEN pr.id_regione = 15 THEN "PA"
			WHEN pr.id_regione = 6 THEN "TS"
			ELSE "IT" END ELSE A.sedelegale_prov END AS ambitoditta
		FROM tmp_dettagli D
        LEFT JOIN tmp_primafattura PF on D.idcontratto = PF.idcontratto and D.periodoriferimento = PF.periodoriferimento
        LEFT JOIN comm.plank_aziende A on D.particellaazienda = A.particellaazienda
        LEFT JOIN comm.plank_geo_provincies pr on A.sedelegale_prov = pr.sigla
	) D 
	LEFT JOIN tmp_fatturato F ON D.codicefattura = F.codicefattura and D.idcontratto = F.idcontratto and D.periodoriferimento = F.periodoriferimento
	LEFT JOIN tmp_erariale E ON D.codicefattura = E.codicefattura and D.idcontratto = E.idcontratto and D.periodoriferimento = E.periodoriferimento
) D
LEFT JOIN tmp_storico_campi sc on D.idcontratto = sc.idcontratto and D.periodoriferimento = sc.periodoriferimento and D.codicefattura = sc.codicefattura
LEFT JOIN tmp_storico_fornitura s on D.idcontratto = s.idcontratto and D.codicefattura = s.codicefattura
LEFT JOIN tmp_storico_contratto c on D.idcontratto = c.idcontratto and D.codicefattura = c.codicefattura
LEFT JOIN comm.plank_contratti_forniture_ee E ON D.idcontratto = E.idcontratto
LEFT JOIN (select distinct coddistr, pivadistr from comm.plank_anadistributori where utility = 'EE') ad on s.distributore = ad.coddistr
LEFT JOIN (select distinct coddistr, pivadistr from comm.plank_anadistributori where utility = 'EE') ad1 on E.distributore = ad1.coddistr
LEFT JOIN tmp_gc gc on Coalesce(c.fornitura_localita_id, E.fornitura_localita_id) = gc.id_citta
LEFT JOIN comm.plank_geo_provincies pr on Coalesce(gc.provincia, c.fornitura_prov, E.fornitura_prov) = pr.sigla;


DROP TEMPORARY TABLE IF EXISTS tmp_dettaglioaccise;
CREATE TEMPORARY TABLE tmp_dettaglioaccise(idcontratto int, periodoriferimento varchar(45), utility varchar(10), accise varchar(45), tipologiacliente varchar(45),
pdp varchar(45), codicefiscale varchar(45), indirizzo varchar(500), codcat varchar(10), provincia varchar(45), paese varchar(45), ambito varchar(45), 
potenzaimpegnata double, percesclusioneaccise double, codicetensione varchar(45), residente int, rettifica int, corrispettivoaccise double, consumo double, consumoaccise double,
accisa varchar(45), tipologia_fornitura_utf varchar(45), decorrenza date, scadenza date, datadistipula date, zonaipex varchar(45), codicefattura varchar(45), dataemissione date, Quadro char(1), Rigo int);

-- QUADRO I
INSERT INTO tmp_dettaglioaccise
select cn.idcontratto, cn.periodoriferimento, 'EE' as utility, IF(cn.destinazioneuso_accise = "", "APPLICATA", cn.destinazioneuso_accise ) as accise, cn.tipologiacliente,
cn.pdp, CASE WHEN cn.tipologiacliente = 'RESELLER' THEN cn.fattura_codfiscale ELSE cn.pivadistr END as pivadistr, cn.fornitura_indirizzo, cn.codcat, cn.fornitura_prov, cn.fornitura_paese, cn.ambito, cn.potenzaimpegnata, cn.percesclusioneaccise,
cn.codicetensione, cn.residente, cn.rettifica, 0 as corrispettivoaccise, cn.consumo, cn.consumo as consumoaccise, NULL as accisa, 
CASE WHEN cn.tipologiacliente = 'RESELLER' THEN 'P' 
	WHEN coalesce(cn.percesclusioneaccise, 0) <> 0 THEN 'Q' ELSE 'M' END as tipologia_fornitura_utf,
cn.decorrenza, cn.scadenza, cn.datadistipula, cn.zonaipex, cn.codicefattura, cn.dataemissione, 'I' as Quadro, 1 as Rigo
from tmp_consumi cn;

-- QUADRO J
INSERT INTO tmp_dettaglioaccise
select cn.idcontratto, cn.periodoriferimento, 'EE' as utility, IF(cn.destinazioneuso_accise = "", "APPLICATA", cn.destinazioneuso_accise ) as accise, cn.tipologiacliente,
cn.pdp, IF(cn.tipologiacliente = 'RESELLER', cn.fattura_codfiscale, cn.fornitura_codfiscale), cn.fornitura_indirizzo, cn.codcat, cn.fornitura_prov, cn.fornitura_paese, cn.ambito, cn.potenzaimpegnata, cn.percesclusioneaccise,
cn.codicetensione, cn.residente, cn.rettifica, coalesce(cn.corrispettivoaccisa, 0) as corrispettivoaccisa, cn.consumo, cn.esenti as consumoaccise, 'ESCLUSI' as accisa, 
CASE WHEN cn.tipologiacliente = 'RESELLER' THEN 'P' 
	WHEN coalesce(cn.percesclusioneaccise, 0) <> 0 THEN 'Q' ELSE 'M' END as tipologia_fornitura_utf,
cn.decorrenza, cn.scadenza, cn.datadistipula, cn.zonaipex, cn.codicefattura, cn.dataemissione,
'J' as Quadro, CASE WHEN cn.tipologiacliente = 'RESELLER' THEN CASE WHEN cn.fornitura_paese IN ("IT", "Italy") THEN 4 ELSE 5 END ELSE 1 END as Rigo
from tmp_consumi cn
where (coalesce(cn.percesclusioneaccise, 0) <> 0  or  IF(cn.destinazioneuso_accise = "", "APPLICATA", cn.destinazioneuso_accise ) <> 'APPLICATA')
AND NOT(cn.tipologiacliente = 'RESELLER' and cn.fornitura_paese IN ("IT", "Italy"));

-- QUADRO L
INSERT INTO tmp_dettaglioaccise
select cn.idcontratto, cn.periodoriferimento, 'EE' as utility, IF(cn.destinazioneuso_accise = "", "APPLICATA", cn.destinazioneuso_accise ) as accise, cn.tipologiacliente,
cn.pdp, IF(cn.tipologiacliente = 'RESELLER', cn.fattura_codfiscale, cn.fornitura_codfiscale), cn.fornitura_indirizzo, cn.codcat, cn.fornitura_prov, cn.fornitura_paese, cn.ambito, cn.potenzaimpegnata, cn.percesclusioneaccise,
cn.codicetensione, cn.residente, cn.rettifica, 0 as corrispettivoaccisa, cn.consumo, cn.esenti as consumoaccise, 'ESENTI' as accisa, 
CASE WHEN cn.tipologiacliente = 'RESELLER' THEN 'P' 
	WHEN coalesce(cn.percesclusioneaccise, 0) <> 0 THEN 'Q' ELSE 'M' END as tipologia_fornitura_utf,
cn.decorrenza, cn.scadenza, cn.datadistipula, cn.zonaipex, cn.codicefattura, cn.dataemissione,
'L' as Quadro, CASE 
 -- WHEN cn.tipologiacliente IN ('ENTE', 'PUBBLICA AMMINISTRAZIONE') THEN 2 
	WHEN cn.tipologiacliente = 'FORZE ARMATE' THEN 3 
    WHEN cn.tipologiacliente <> 'DOMESTICO' and  cn.impiantofotovoltaicopresente = 1 THEN 6 ELSE 9 END as Rigo
from tmp_consumi cn
where  cn.esenti <> 0 and NOT(coalesce(cn.percesclusioneaccise, 0) <> 0  or  IF(cn.destinazioneuso_accise = "", "APPLICATA", cn.destinazioneuso_accise ) <> 'APPLICATA');

INSERT INTO tmp_dettaglioaccise
-- QUADRO M - abitazioni 
select cn.idcontratto, cn.periodoriferimento, 'EE' as utility, IF(cn.destinazioneuso_accise = "", "APPLICATA", cn.destinazioneuso_accise ) as accise, cn.tipologiacliente,
cn.pdp, IF(cn.tipologiacliente = 'RESELLER', cn.fattura_codfiscale, cn.fornitura_codfiscale), cn.fornitura_indirizzo, cn.codcat, cn.fornitura_prov, cn.fornitura_paese, cn.ambito, cn.potenzaimpegnata, cn.percesclusioneaccise,
cn.codicetensione, cn.residente, cn.rettifica, coalesce(cn.corrispettivoaccisa, 0) as corrispettivoaccisa, cn.consumo, cn.consumotassato as consumoaccise, 'TASSATI' as accisa, 
CASE WHEN cn.tipologiacliente = 'RESELLER' THEN 'P' 
	WHEN coalesce(cn.percesclusioneaccise, 0) <> 0 THEN 'Q' ELSE 'M' END as tipologia_fornitura_utf,
cn.decorrenza, cn.scadenza, cn.datadistipula, cn.zonaipex, cn.codicefattura, cn.dataemissione,
'M' as Quadro, CASE WHEN residente = 1 THEN 1 ELSE 2 END as Rigo
from tmp_consumi cn
WHERE ((cn.codicetensione like 'TD%' and consumotassato <> 0) OR coalesce(cn.recuperataResidente, 0) <> 0) and rettifica = 0 
and IF(cn.destinazioneuso_accise = "", "APPLICATA", cn.destinazioneuso_accise ) <> 'NON APPLICATA';

-- QUADRO M - recupero 
INSERT INTO tmp_dettaglioaccise
select cn.idcontratto, cn.periodoriferimento, 'EE' as utility, IF(cn.destinazioneuso_accise = "", "APPLICATA", cn.destinazioneuso_accise ) as accise, cn.tipologiacliente,
cn.pdp, IF(cn.tipologiacliente = 'RESELLER', cn.fattura_codfiscale, cn.fornitura_codfiscale), cn.fornitura_indirizzo, cn.codcat, cn.fornitura_prov, cn.fornitura_paese, cn.ambito, cn.potenzaimpegnata, cn.percesclusioneaccise,
cn.codicetensione, cn.residente, cn.rettifica, coalesce(cn.corrispettivoaccisa, 0) as corrispettivoaccisa, cn.consumo, cn.recuperataResidente as consumoaccise, 'RECUPERATI A TASSAZIONE' as accisa, 
CASE WHEN cn.tipologiacliente = 'RESELLER' THEN 'P' 
	WHEN coalesce(cn.percesclusioneaccise, 0) <> 0 THEN 'Q' ELSE 'M' END as tipologia_fornitura_utf,
cn.decorrenza, cn.scadenza, cn.datadistipula, cn.zonaipex, cn.codicefattura, cn.dataemissione,
'M' as Quadro, 3 as Rigo
from tmp_consumi cn
WHERE coalesce(cn.recuperataResidente, 0) <> 0 and rettifica = 0
and IF(cn.destinazioneuso_accise = "", "APPLICATA", cn.destinazioneuso_accise ) <> 'NON APPLICATA';

-- QUADRO M - locali 
INSERT INTO tmp_dettaglioaccise
select cn.idcontratto, cn.periodoriferimento, 'EE' as utility, IF(cn.destinazioneuso_accise = "", "APPLICATA", cn.destinazioneuso_accise ) as accise, cn.tipologiacliente,
cn.pdp, IF(cn.tipologiacliente = 'RESELLER', cn.fattura_codfiscale, cn.fornitura_codfiscale), cn.fornitura_indirizzo, cn.codcat, cn.fornitura_prov, cn.fornitura_paese, cn.ambito, cn.potenzaimpegnata, cn.percesclusioneaccise,
cn.codicetensione, cn.residente, cn.rettifica, coalesce(cn.corrispettivoaccisa, 0) as corrispettivoaccisa, cn.consumo, cn.consumotassato as consumoaccise, 'TASSATI' as accisa, 
CASE WHEN cn.tipologiacliente = 'RESELLER' THEN 'P' 
	WHEN coalesce(cn.percesclusioneaccise, 0) <> 0 THEN 'Q' ELSE 'M' END as tipologia_fornitura_utf,
cn.decorrenza, cn.scadenza, cn.datadistipula, cn.zonaipex, cn.codicefattura, cn.dataemissione,
'M' as Quadro, CASE WHEN cn.consumo < 1200000 THEN IF(cn.scaglione = 1, 9, 10) ELSE IF(cn.scaglione = 1, 11, 12) END as Rigo
from tmp_consumi cn
WHERE codicetensione not like 'TD%' and coalesce(cn.recuperataResidente, 0) = 0 and rettifica = 0
and IF(cn.destinazioneuso_accise = "", "APPLICATA", cn.destinazioneuso_accise ) <> 'NON APPLICATA';

INSERT INTO tmp_dettaglioaccise
-- QUADRO K - abitazioni 
select cn.idcontratto, cn.periodoriferimento, 'EE' as utility, IF(cn.destinazioneuso_accise = "", "APPLICATA", cn.destinazioneuso_accise ) as accise, cn.tipologiacliente,
cn.pdp, IF(cn.tipologiacliente = 'RESELLER', cn.fattura_codfiscale, cn.fornitura_codfiscale), cn.fornitura_indirizzo, cn.codcat, cn.fornitura_prov, cn.fornitura_paese, cn.ambito, cn.potenzaimpegnata, cn.percesclusioneaccise,
cn.codicetensione, cn.residente, cn.rettifica, coalesce(cn.corrispettivoaccisa, 0) as corrispettivoaccisa, cn.consumo, cn.consumotassato as consumoaccise, 'TASSATI' as accisa, 
CASE WHEN cn.tipologiacliente = 'RESELLER' THEN 'P' 
	WHEN coalesce(cn.percesclusioneaccise, 0) <> 0 THEN 'Q' ELSE 'M' END as tipologia_fornitura_utf,
cn.decorrenza, cn.scadenza, cn.datadistipula, cn.zonaipex, cn.codicefattura, cn.dataemissione,
'K' as Quadro, CASE WHEN residente = 1 THEN 1 ELSE 2 END as Rigo
from tmp_consumi cn
WHERE ((cn.codicetensione like 'TD%' and consumotassato <> 0)  OR coalesce(cn.recuperataResidente, 0) <> 0) and rettifica=1
and IF(cn.destinazioneuso_accise = "", "APPLICATA", cn.destinazioneuso_accise ) <> 'NON APPLICATA';

-- QUADRO K - recupero 
INSERT INTO tmp_dettaglioaccise
select cn.idcontratto, cn.periodoriferimento, 'EE' as utility, IF(cn.destinazioneuso_accise = "", "APPLICATA", cn.destinazioneuso_accise ) as accise, cn.tipologiacliente,
cn.pdp, IF(cn.tipologiacliente = 'RESELLER', cn.fattura_codfiscale, cn.fornitura_codfiscale), cn.fornitura_indirizzo, cn.codcat, cn.fornitura_prov, cn.fornitura_paese, cn.ambito, cn.potenzaimpegnata, cn.percesclusioneaccise,
cn.codicetensione, cn.residente, cn.rettifica, coalesce(cn.corrispettivoaccisa, 0) as corrispettivoaccisa, cn.consumo, cn.recuperataResidente as consumoaccise, 'RECUPERATI A TASSAZIONE' as accisa, 
CASE WHEN cn.tipologiacliente = 'RESELLER' THEN 'P' 
	WHEN coalesce(cn.percesclusioneaccise, 0) <> 0 THEN 'Q' ELSE 'M' END as tipologia_fornitura_utf,
cn.decorrenza, cn.scadenza, cn.datadistipula, cn.zonaipex, cn.codicefattura, cn.dataemissione,
'K' as Quadro, 3 as Rigo
from tmp_consumi cn
WHERE coalesce(cn.recuperataResidente, 0) <> 0  and rettifica = 1
and IF(cn.destinazioneuso_accise = "", "APPLICATA", cn.destinazioneuso_accise ) <> 'NON APPLICATA';


-- QUADRO K - locali 
INSERT INTO tmp_dettaglioaccise
select cn.idcontratto, cn.periodoriferimento, 'EE' as utility, IF(cn.destinazioneuso_accise = "", "APPLICATA", cn.destinazioneuso_accise ) as accise, cn.tipologiacliente,
cn.pdp, IF(cn.tipologiacliente = 'RESELLER', cn.fattura_codfiscale, cn.fornitura_codfiscale), cn.fornitura_indirizzo, cn.codcat, cn.fornitura_prov, cn.fornitura_paese, cn.ambito, cn.potenzaimpegnata, cn.percesclusioneaccise,
cn.codicetensione, cn.residente, cn.rettifica, coalesce(cn.corrispettivoaccisa, 0) as corrispettivoaccisa, cn.consumo, cn.consumotassato as consumoaccise, 'TASSATI' as accisa, 
CASE WHEN cn.tipologiacliente = 'RESELLER' THEN 'P' 
	WHEN coalesce(cn.percesclusioneaccise, 0) <> 0 THEN 'Q' ELSE 'M' END as tipologia_fornitura_utf,
cn.decorrenza, cn.scadenza, cn.datadistipula, cn.zonaipex, cn.codicefattura, cn.dataemissione,
'K' as Quadro, 4 as Rigo
from tmp_consumi cn
WHERE codicetensione not like 'TD%' and coalesce(cn.recuperataResidente, 0) = 0 and rettifica = 1
and IF(cn.destinazioneuso_accise = "", "APPLICATA", cn.destinazioneuso_accise ) <> 'NON APPLICATA';

DROP TEMPORARY TABLE IF EXISTS tmp_righi;
CREATE TEMPORARY TABLE tmp_righi
SELECT * FROM tmp_dettaglioaccise;

INSERT INTO tmp_dettaglioaccise
Select cn.idcontratto, cn.periodoriferimento, 'EE' as utility, accise, cn.tipologiacliente,
cn.pdp, cn.codicefiscale, cn.indirizzo, cn.codcat, cn.provincia, cn.paese, cn.ambito, cn.potenzaimpegnata, cn.percesclusioneaccise,
cn.codicetensione, cn.residente, cn.rettifica, corrispettivoaccise, cn.consumo, consumoaccise, 'TASSATI' as accisa, tipologia_fornitura_utf,
cn.decorrenza, cn.scadenza, cn.datadistipula, cn.zonaipex, cn.codicefattura, cn.dataemissione, 'P' as Quadro, 1 as Rigo
FROM tmp_righi cn
WHERE Quadro = 'M' and Rigo in (1, 3);

INSERT INTO tmp_dettaglioaccise
Select cn.idcontratto, cn.periodoriferimento, 'EE' as utility, accise, cn.tipologiacliente,
cn.pdp, cn.codicefiscale, cn.indirizzo, cn.codcat, cn.provincia, cn.paese, cn.ambito, cn.potenzaimpegnata, cn.percesclusioneaccise,
cn.codicetensione, cn.residente, cn.rettifica, corrispettivoaccise, cn.consumo, consumoaccise, 'TASSATI' as accisa, tipologia_fornitura_utf,
cn.decorrenza, cn.scadenza, cn.datadistipula, cn.zonaipex, cn.codicefattura, cn.dataemissione, 'P' as Quadro, 2 as Rigo
FROM tmp_righi cn
WHERE Quadro = 'M' and Rigo = 2;

INSERT INTO tmp_dettaglioaccise
Select cn.idcontratto, cn.periodoriferimento, 'EE' as utility, accise, cn.tipologiacliente,
cn.pdp, cn.codicefiscale, cn.indirizzo, cn.codcat, cn.provincia, cn.paese, cn.ambito, cn.potenzaimpegnata, cn.percesclusioneaccise,
cn.codicetensione, cn.residente, cn.rettifica, corrispettivoaccise, cn.consumo, consumoaccise, 'TASSATI' as accisa, tipologia_fornitura_utf,
cn.decorrenza, cn.scadenza, cn.datadistipula, cn.zonaipex, cn.codicefattura, cn.dataemissione, 'P' as Quadro, 4 as Rigo
FROM tmp_righi cn
WHERE Quadro = 'M' and Rigo IN (9,11);

INSERT INTO tmp_dettaglioaccise
Select cn.idcontratto, cn.periodoriferimento, 'EE' as utility, accise, cn.tipologiacliente,
cn.pdp, cn.codicefiscale, cn.indirizzo, cn.codcat, cn.provincia, cn.paese, cn.ambito, cn.potenzaimpegnata, cn.percesclusioneaccise,
cn.codicetensione, cn.residente, cn.rettifica, corrispettivoaccise, cn.consumo, consumoaccise, 'TASSATI' as accisa, tipologia_fornitura_utf,
cn.decorrenza, cn.scadenza, cn.datadistipula, cn.zonaipex, cn.codicefattura, cn.dataemissione, 'P' as Quadro, 5 as Rigo
FROM tmp_righi cn
WHERE Quadro = 'M' and Rigo = 10;

INSERT INTO tmp_dettaglioaccise
Select cn.idcontratto, cn.periodoriferimento, 'EE' as utility, accise, cn.tipologiacliente,
cn.pdp, cn.codicefiscale, cn.indirizzo, cn.codcat, cn.provincia, cn.paese, cn.ambito, cn.potenzaimpegnata, cn.percesclusioneaccise,
cn.codicetensione, cn.residente, cn.rettifica, corrispettivoaccise, cn.consumo, consumoaccise, 'TASSATI' as accisa, tipologia_fornitura_utf,
cn.decorrenza, cn.scadenza, cn.datadistipula, cn.zonaipex, cn.codicefattura, cn.dataemissione, 'P' as Quadro, 
CASE WHEN Rigo IN (1, 2, 3, 4) THEN 10 WHEN Rigo in (5, 6, 7, 8) THEN 11 ELSE null END as Rigo
FROM tmp_righi cn
WHERE Quadro = 'K' and Rigo between 1 and 8;

DROP TEMPORARY TABLE IF EXISTS tmp_righi;
CREATE TEMPORARY TABLE tmp_righi
SELECT * FROM tmp_dettaglioaccise WHERE Quadro = 'P';

-- ARROTONDAMENTI 
INSERT INTO tmp_dettaglioaccise
select
0 AS idcontratto, '' AS periodoriferimento, 'EE' as utility, '' AS accise, '' AS tipologiacliente,
'' AS pdp, '' AS codicefiscale, '' AS indirizzo, '' AS codcat, cn.provincia, '' AS paese, cn.ambito, 0 AS potenzaimpegnata, 0 as percesclusioneaccise,
'' AS codicetensione, 0 AS residente, 0 as rettifica, Round(Round(SUM(corrispettivoaccise * consumoaccise), 2) - ROUND(SUM(ROUND(corrispettivoaccise * consumoaccise, 2)),2), 2)  as corrispettivoaccisa, 
0 as consumo, 0 as consumoaccise, 'TASSATI' as accisa, '' as tipologia_fornitura_utf,
'19990101' as decorrenza, '19990101' as scadenza, '19990101' as datadistipula, '' as zonaipex, '' as codicefattura, '19990101' as dataemissione, 'P' as Quadro, 13 as Rigo
from tmp_righi cn
where cn.Quadro = 'P'
group by  provincia
having  abs(Round(SUM(corrispettivoaccise * consumoaccise), 2) - ROUND(SUM(ROUND(corrispettivoaccise * consumoaccise, 2)),2)) > 0;

INSERT INTO tmp_righi
SELECT * FROM tmp_dettaglioaccise WHERE Quadro = 'P' and Rigo = 13;

-- Rigo P14
INSERT INTO tmp_dettaglioaccise
select
0 AS idcontratto, '' AS periodoriferimento, 'EE' as utility, '' AS accise, '' AS tipologiacliente,
'' AS pdp, '' AS codicefiscale, '' AS indirizzo, '' AS codcat, cn.provincia, '' AS paese, cn.ambito, 0 AS potenzaimpegnata, 0 as percesclusioneaccise,
'' AS codicetensione, 0 AS residente, 0 as rettifica, Round(SUM(corrispettivoaccise * IF(rigo = 13, 1, consumoaccise)), 2)  as corrispettivoaccisa, 
0 as consumo, 0 as consumoaccise, 'TASSATI' as accisa, '' as tipologia_fornitura_utf,
'19990101' as decorrenza, '19990101' as scadenza, '19990101' as datadistipula, '' as zonaipex, '' as codicefattura, '19990101' as dataemissione, 'P' as Quadro, 14 as Rigo
from tmp_righi cn
where cn.Quadro = 'P'
group by  provincia;

INSERT INTO tmp_righi
SELECT * FROM tmp_dettaglioaccise WHERE Quadro = 'P' and Rigo = 14;

INSERT INTO tmp_dettaglioaccise
Select 0 AS idcontratto, '' AS periodoriferimento, 'EE' as utility, '' AS accise, '' AS tipologiacliente,
'' AS pdp, '' AS codicefiscale, '' AS indirizzo, '' AS codcat, '' as provincia, '' AS paese, cn.ambito, 0 AS potenzaimpegnata, 0 as percesclusioneaccise,
'' AS codicetensione, 0 AS residente, 0 as rettifica,SUM(corrispettivoaccise)  as corrispettivoaccisa, 
0 as consumo, 0 as consumoaccise, 'TASSATI' as accisa, '' as tipologia_fornitura_utf,
'19990101' as decorrenza, '19990101' as scadenza, '19990101' as datadistipula, '' as zonaipex, '' as codicefattura, '19990101' as dataemissione, 'Q' as Quadro, 1 as Rigo
FROM tmp_righi cn
WHERE Quadro = 'P' and Rigo = 14
GROUP BY ambito;


DELETE FROM plank_dogane_reportannuale_dettaglioquadri
where tokenreport = var_token and utility = 'EE';

INSERT INTO plank_dogane_reportannuale_dettaglioquadri(
idcontratto, periodoriferimento, utility, accise, tipologiacliente, pdp, codicefiscale, indirizzo, codcat, provincia, paese, ambito, 
potenzaimpegnata, percesclusioneaccise, codicetensione, residente, rettifica, corrispettivoaccise, consumo, 
consumoaccise, accisa, tipologia_fornitura_utf, decorrenza, scadenza, datadistipula, zonaipex, codicefattura, dataemissione, Quadro, Rigo, tokenreport, particellaazienda)
select idcontratto, periodoriferimento, utility, accise, tipologiacliente, pdp, codicefiscale, indirizzo, codcat, provincia, paese, ambito, 
potenzaimpegnata, percesclusioneaccise, codicetensione, residente, rettifica, corrispettivoaccise, consumo, consumoaccise, accisa, tipologia_fornitura_utf, decorrenza, scadenza, 
datadistipula, zonaipex, codicefattura, dataemissione, Quadro, Rigo, var_token, var_azienda
FROM tmp_dettaglioaccise
ORDER BY Quadro, Rigo;

END